import {
    Body,
    Controller,
    Get,
    NotFoundException,
    Param,
    Post,
    Res,
    ServiceUnavailableException,
    UploadedFile,
    UseInterceptors,
} from "@nestjs/common";
import { FileInterceptor } from "@nestjs/platform-express";
import { Response } from "express";
import { StorageService } from "./gsc.service";
import { StorageFile } from "./storage.file";

@Controller("media")
export class MediaController {
    constructor(private storageService: StorageService) { }

    @Post()
    @UseInterceptors(
        FileInterceptor("file", { limits: { files: 1, fileSize: 1024 * 1024 } })
    )
    async uploadMedia(
        @UploadedFile() file: Express.Multer.File,
        @Body("mediaId") mediaId: string
    ) {
        await this.storageService.save(file.originalname, file.mimetype, file.buffer, [{ mediaId: mediaId }]);
    }

    @Get("/:mediaId")
    async downloadMedia(@Param("mediaId") mediaId: string, @Res() res: Response) {
        let storageFile: StorageFile;
        try {
            storageFile = await this.storageService.get("media/" + mediaId);
        } catch (e) {
            if (e.message.toString().includes("No such object")) {
                throw new NotFoundException("image not found");
            } else {
                throw new ServiceUnavailableException("internal error");
            }
        }
        res.setHeader("Content-Type", storageFile.contentType);
        res.setHeader("Cache-Control", "max-age=60d");
        res.end(storageFile.buffer);
    }
}